/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2024 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
/* USER CODE END Header */
/* Includes ------------------------------------------------------------------*/
#include "main.h"
#include "cmsis_os.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include <string.h>
#include <stdbool.h> 
/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */
#define X 0
#define Y 1
#define CRC_POLY  0x12F
#define SPI_DATA_LEN_BITS 32
#define CRC_SPI_SEED 0xFF
#define CRC_LEN 8
#define MSG_LEN 32
#define CRC_SEED 0xFF
#define MAX_CRC 0xFF
#define MAX_UINT64_T 0xFFFFFFFFFFFFFFFF
/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */

/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/

FDCAN_HandleTypeDef hfdcan1;

SPI_HandleTypeDef hspi3;

TIM_HandleTypeDef htim1;

UART_HandleTypeDef huart4;

/* Definitions for Init_test */
osThreadId_t Init_testHandle;
const osThreadAttr_t Init_test_attributes = {
  .name = "Init_test",
  .stack_size = 1024 * 4,
  .priority = (osPriority_t) osPriorityNormal,
};
/* Definitions for CAN_period */
osThreadId_t CAN_periodHandle;
const osThreadAttr_t CAN_period_attributes = {
  .name = "CAN_period",
  .stack_size = 1024 * 4,
  .priority = (osPriority_t) osPriorityNormal,
};
/* Definitions for Accelerometer_run */
osThreadId_t Accelerometer_runHandle;
const osThreadAttr_t Accelerometer_run_attributes = {
  .name = "Accelerometer_run",
  .stack_size = 1024 * 4,
  .priority = (osPriority_t) osPriorityNormal,
};
/* USER CODE BEGIN PV */
FDCAN_TxHeaderTypeDef TxHeader;
FDCAN_RxHeaderTypeDef RxHeader;
volatile uint32_t time;
uint8_t UARTRXcmd[2]={0,0};
uint8_t testbuf[4]={0xAA,0xAA,0xAA,0xAA};
uint32_t result_1=0;//must be moved to first task
uint32_t timelist[50]={0,};

uint8_t SPI_RXbuf[4]={0,0,0,0};
uint8_t SPI_resp[4]={10,20,30,40};
static float XGE_X[801]={0.139910, 0.279820, 0.139910,0.000000,0.279820,-0.139910,0.559640,-0.139910,0.279820,0.419730,0.279820,0.000000,0.000000,0.139910,0.139910,0.279820,0.419730,0.279820,-0.139910,-0.279820,0.139910,0.279820,-0.139910,0.279820,-0.419730,0.139910,-0.559640,0.559640,0.139910,0.699550,-0.419730,-0.139910,0.000000,-0.559640,0.279820,0.559640,0.000000,0.000000,-0.559640,0.419730,-0.419730,0.000000,-0.139910,-0.279820,0.839460,0.139910,-0.139910,0.000000,0.000000,-0.139910,0.279820,-0.559640,0.000000,-0.419730,0.000000,0.000000,-0.139910,0.279820,-0.139910,-0.279820,0.000000,-0.419730,-0.139910,-0.279820,-0.139910,-0.279820,0.139910,-0.419730,-0.139910,0.139910,0.279820,0.139910,-0.139910,0.139910,0.419730,-0.699550,0.279820,0.139910,-0.139910,0.559640,-0.139910,-0.419730,0.139910,-0.419730,0.000000,-0.139910,-0.279820,-0.139910,-0.279820,0.419730,-0.559640,0.000000,0.000000,-0.559640,0.839460,-0.839460,0.419730,-1.259190,-0.139910,-0.279820,0.559640,-0.139910,0.839460,-0.279820,0.000000,-0.139910,0.139910,-0.279820,-0.139910,0.000000,-0.139910,-0.279820,-0.559640,-0.139910,-0.279820,0.279820,0.139910,-0.699550,0.279820,-0.279820,0.139910,-0.139910,1.119280,-0.839460,-0.139910,-0.279820,-0.559640,0.419730,-0.559640,0.839460,-0.699550,0.139910,-0.139910,0.419730,0.000000,0.139910,0.279820,-0.279820,0.139910,0.279820,-0.279820,0.559640,-0.699550,-0.419730,-0.139910,0.419730,-0.279820,-0.139910,-0.279820,-0.139910,0.279820,-0.139910,0.419730,0.419730,0.419730,0.139910,0.139910,-0.139910,0.139910,0.279820,0.000000,0.139910,0.279820,0.139910,0.419730,0.139910,-0.139910,-0.139910,0.000000,-0.279820,0.279820,0.279820,0.000000,0.839460,0.139910,-0.139910,0.139910,0.000000,0.139910,0.559640,-0.559640,0.699550,-0.419730,0.559640,0.279820,0.139910,0.699550,-0.419730,0.419730,0.000000,0.419730,0.419730,-0.699550,0.559640,-0.139910,0.139910,0.839460,-0.419730,0.419730,-0.139910,0.419730,-0.699550,0.279820,0.279820,-0.839460,1.818830,-3.217930,1.539010,-0.279820,-14.410732,6.156041,-4.756941,1.259190,5.736311,-0.279820,-21.965873,18.608032,-9.513881,-8.394601,-4.756941,1.259190,-12.312082,-13.711182,3.777570,-3.777570,-11.892352,14.830462,-10.493251,-15.949742,-5.036761,-9.513881,-16.369472,-5.036761,-6.715681,-19.867223,-6.016131,-32.599034,18.468122,-34.837594,14.970372,6.435861,-1.958740,-9.234061,-3.078020,-12.731812,0.839460,3.917481,0.000000,-7.415231,-5.176671,-32.599034,-14.270822,-10.073521,2.098650,1.259190,-6.575771,-2.658290,-13.711182,-0.979370,2.518380,2.938110,2.938110,-13.571272,-0.419730,-7.555141,-10.073521,-13.291452,28.401734,-28.681554,1.119280,-12.451992,-11.332711,-1.818830,-12.451992,2.798200,-0.419730,-9.653791,-0.139910,-26.722813,9.933611,6.715681,-15.250192,-14.970372,17.208932,-12.032262,-27.282454,16.929112,-6.855591,-3.777570,6.295951,-15.949742,7.415231,-21.546143,-12.871722,-17.908482,11.052891,-10.353341,-7.695051,-4.756941,1.539010,10.353341,-15.530012,0.839460,9.513881,-39.594535,46.869856,-25.463623,6.016131,-3.637660,-13.011632,9.653791,-25.603533,7.135411,-3.497750,-14.970372,-2.938110,10.213431,-5.176671,-28.821464,1.818830,-20.007133,-2.518380,13.151542,-38.055525,24.064523,-29.660924,11.332711,-3.917481,-16.509382,13.571272,-20.286953,2.378470,-26.303083,1.119280,-44.631296,3.777570,-20.007133,-16.789202,5.036761,-19.307582,-16.089652,-10.633161,-38.335345,11.192801,-33.858224,13.151542,-31.060024,-10.912981,-14.130912,-15.390102,10.073521,-8.814331,-20.566773,-12.032262,-6.715681,-32.459124,22.105783,-41.133545,-3.917481,-17.488752,-21.825963,-12.312082,-18.747942,-18.468122,-24.484253,-42.112915,15.250192,-61.140678,21.406233,-17.768572,-22.805333,27.142544,-58.762208,-5.596401,-1.818830,-9.933611,-20.566773,-7.415231,-11.332711,-7.555141,-14.550642,-26.163173,5.596401,-23.784703,-14.830462,-23.364973,-6.575771,-8.674421,-15.390102,-15.809832,-23.085153,-12.172172,-21.546143,-13.991002,-17.208932,-13.851092,-18.188302,-17.908482,-8.254691,-19.167672,-19.447493,-18.048392,-3.357840,-13.851092,-14.410732,-14.550642,-4.896851,-16.649292,-12.871722,-13.291452,-6.995501,-9.653791,-9.373971,-22.805333,-3.917481,-6.295951,-15.530012,-12.871722,-7.695051,-6.995501,-9.094151,-6.295951,-10.213431,-12.731812,5.736311,-9.653791,-4.896851,10.493251,-19.587403,20.007133,-24.204433,14.830462,-22.665423,6.715681,-14.830462,-5.596401,-2.238560,-4.057391,-3.357840,-11.612531,8.814331,-5.176671,4.896851,-13.431362,6.016131,-14.970372,1.678920,-9.234061,4.337211,-9.653791,1.399100,-8.814331,8.114781,-7.834961,6.715681,-11.332711,7.834961,-10.493251,9.373971,-12.032262,10.213431,-11.612531,4.896851,-8.674421,7.695051,-11.052891,3.497750,-6.295951,6.435861,-2.098650,5.316581,-6.575771,6.156041,-8.674421,6.715681,-4.057391,7.695051,-18.048392,11.892352,-7.135411,5.176671,-1.818830,5.456491,-5.316581,-2.098650,-0.699550,-3.357840,0.279820,0.699550,1.958740,-5.736311,3.217930,-3.357840,2.238560,-2.378470,1.259190,3.497750,-4.057391,-5.176671,10.213431,-7.135411,5.736311,0.699550,4.477121,-6.435861,5.456491,-5.316581,2.798200,-8.394601,2.798200,-5.176671,0.139910,3.357840,1.818830,-2.378470,0.139910,-4.197301,5.036761,-3.917481,-1.678920,5.736311,-3.917481,1.958740,-3.217930,1.119280,-1.818830,-3.497750,3.497750,2.238560,1.259190,3.497750,-3.078020,1.259190,-3.917481,2.098650,-0.979370,3.217930,1.119280,0.419730,-0.139910,-1.119280,0.839460,-1.399100,1.818830,-0.559640,0.139910,3.078020,-1.399100,1.539010,-1.259190,1.119280,-0.839460,0.419730,0.699550,-0.559640,0.699550,-0.559640,0.279820,-0.559640,-0.139910,2.938110,0.979370,1.399100,-1.539010,0.839460,1.818830,-3.917481,6.715681,-3.637660,2.658290,1.119280,-1.539010,3.917481,-2.098650,4.197301,-0.979370,-2.938110,0.979370,-0.559640,-0.559640,1.399100,-1.119280,-0.699550,0.979370,-2.098650,0.979370,0.979370,-0.559640,-0.979370,-2.238560,-1.678920,-1.818830,-1.119280,1.958740,-1.958740,0.699550,-0.139910,0.139910,0.139910,-3.637660,0.979370,-0.839460,-0.839460,0.979370,-2.238560,0.000000,-2.378470,2.098650,-2.378470,-2.098650,0.139910,-1.119280,-0.699550,-0.979370,-0.139910,-0.559640,0.139910,-1.119280,-1.259190,0.839460,-1.539010,1.818830,-1.818830,1.119280,0.139910,-0.699550,0.699550,-0.839460,0.139910,-1.259190,0.279820,-1.958740,-0.139910,-0.839460,-0.979370,0.000000,0.139910,0.279820,0.139910,-0.559640,0.000000,0.699550,-0.839460,-0.139910,-1.399100,1.259190,-1.119280,-0.979370,-1.119280,-3.357840,0.000000,-0.559640,0.139910,-0.139910,-0.559640,0.139910,-0.979370,0.419730,0.559640,-0.419730,0.139910,0.279820,-1.958740,0.419730,-0.699550,0.559640,-0.559640,-0.279820,-0.979370,-0.979370,-0.839460,-0.979370,0.000000,0.000000,0.139910,-1.399100,-0.419730,-0.979370,-0.279820,-0.839460,0.279820,0.839460,-0.419730,0.139910,1.678920,-0.699550,-0.139910,-0.279820,-0.699550,0.979370,0.559640,0.979370,0.839460,-0.139910,0.979370,0.279820,0.559640,0.559640,-0.839460,-0.559640,0.000000,-1.399100,-1.259190,-0.839460,-0.699550,-0.139910,-0.559640,-0.139910,0.559640,0.559640,0.419730,0.279820,-0.419730,-0.559640,0.419730,0.000000,0.000000,0.699550,-0.419730,-0.139910,-0.139910,0.139910,0.139910,0.139910,0.559640,0.559640,0.699550,0.699550,0.139910,-0.279820,-1.259190,-2.798200,3.357840,-1.399100,0.979370,1.539010,-2.238560,1.259190,0.839460,0.559640,0.139910,-0.559640,3.637660,-0.699550,0.000000,-2.238560,0.279820,0.979370,-0.699550,-0.559640,-0.559640,-0.279820,0.419730,-0.839460,0.279820,0.559640,-0.279820,0.000000,-0.699550,0.559640,-0.279820,0.279820,0.559640,-1.119280,0.419730,-0.139910,-0.279820,-0.839460,-0.139910,-0.419730,0.000000,-0.839460,-0.139910,0.419730,0.139910,0.559640,-0.839460,-0.419730,-0.279820,-0.559640,0.279820,-0.279820,0.000000,-0.979370,-0.139910,0.000000,0.000000,0.139910,-0.139910,0.000000,-0.419730,0.279820,0.419730,0.000000,0.139910,-1.119280,0.139910,-0.699550,-0.699550,-0.419730,-0.419730};
static float XGE_Y[801]={-0.684152,-0.273661,-0.410491,-0.410491,0.136830,0.000000,-0.410491,0.136830,0.273661,0.000000,0.410491,0.000000,-0.136830,0.000000,0.000000,0.000000,-0.273661,-0.136830,0.136830,0.000000,0.684152,0.136830,0.000000,-0.547322,-0.273661,-0.273661,0.136830,-0.136830,-0.410491,-0.273661,-0.273661,0.136830,0.273661,-0.547322,-0.547322,-0.136830,-0.136830,-0.273661,-0.273661,0.273661,-0.136830,0.000000,-0.136830,0.000000,0.410491,0.136830,-0.410491,-0.136830,0.136830,0.273661,-0.273661,0.000000,-0.136830,-0.136830,-0.547322,-0.410491,0.410491,0.820983,-0.136830,-0.136830,-0.273661,0.273661,0.000000,-0.136830,0.000000,-0.136830,0.136830,-0.136830,-0.547322,-0.410491,0.547322,0.136830,-0.410491,0.410491,0.273661,-0.957813,0.136830,-0.273661,-0.273661,0.000000,0.000000,-0.273661,-0.136830,-0.410491,-0.273661,-0.273661,0.410491,-0.684152,-0.136830,-0.136830,-0.410491,-0.410491,-0.410491,0.136830,0.547322,0.273661,-0.136830,-0.273661,-0.410491,0.136830,0.273661,0.410491,-0.136830,0.000000,-0.136830,0.136830,0.000000,-0.136830,0.273661,-0.410491,-0.136830,-0.136830,-0.136830,-0.273661,-0.273661,-0.136830,0.000000,-0.684152,-0.547322,0.136830,-0.684152,0.136830,0.000000,-0.547322,0.000000,-0.136830,-0.273661,0.410491,-0.136830,0.273661,0.000000,0.136830,0.000000,-0.410491,0.273661,0.000000,0.273661,-0.273661,-0.273661,0.410491,0.000000,0.273661,-0.547322,0.000000,-0.273661,-0.273661,0.000000,0.410491,-0.136830,-0.136830,0.273661,0.136830,-0.547322,0.273661,0.136830,0.000000,0.410491,0.273661,0.410491,0.136830,0.000000,0.273661,0.136830,-0.410491,0.000000,0.410491,0.273661,-0.136830,-0.273661,-0.136830,0.000000,0.273661,0.136830,0.547322,-0.273661,-0.136830,0.000000,-0.136830,0.820983,-0.547322,0.136830,0.547322,0.000000,0.000000,0.547322,0.000000,0.273661,0.136830,0.410491,0.000000,0.000000,0.410491,-0.136830,0.957813,-0.410491,0.547322,0.000000,-0.136830,0.000000,0.273661,0.136830,0.000000,0.000000,0.000000,0.136830,1.231474,1.368304,1.231474,2.052456,1.641965,4.925895,6.431030,-7.115182,3.010269,-10.125451,5.199556,-1.505135,12.177907,5.610047,1.915626,-0.273661,1.778795,7.388843,9.714960,-0.820983,7.525673,10.535942,-8.757147,1.778795,-0.684152,15.872329,1.505135,25.176797,-14.777685,23.124341,-8.483486,2.873439,6.841521,4.241743,12.451568,-15.872329,-0.957813,-10.262281,-7.799334,6.020538,20.935054,34.618096,4.104913,-2.736608,-6.157369,8.893977,14.777685,25.176797,7.662503,13.546211,5.336386,-9.304468,6.567860,11.630586,8.620316,-5.336386,10.672773,1.505135,-18.335276,2.873439,29.281710,36.944213,2.599778,6.704691,-14.230364,-9.578129,2.599778,25.724119,2.052456,9.988621,7.252012,-7.388843,3.968082,-2.462948,7.252012,19.566750,6.567860,23.808493,8.620316,0.820983,2.599778,13.683042,20.387732,0.136830,23.671662,-6.567860,-1.641965,-10.399112,11.220094,5.199556,-6.841521,8.483486,31.881488,9.578129,4.789065,15.461837,6.978351,17.514294,18.335276,-2.189287,28.187066,0.820983,16.145989,9.167638,17.651124,21.619206,-16.830142,2.189287,20.798224,8.893977,14.093533,5.062725,14.914516,-7.388843,28.323897,-6.841521,-1.505135,7.252012,-8.893977,28.187066,5.610047,45.975021,19.840411,9.304468,7.936164,19.019428,4.925895,26.818762,2.052456,26.271440,22.987510,40.638634,28.734388,11.767416,42.417430,15.598668,11.083264,-6.704691,43.375243,6.157369,3.694421,51.037746,3.283930,0.273661,-5.336386,30.786844,23.534832,-12.588399,30.102692,6.704691,10.672773,11.767416,10.262281,12.177907,17.514294,8.757147,22.987510,0.273661,2.462948,26.955592,22.166528,17.924785,-21.482376,27.913405,16.282820,5.062725,39.680821,5.610047,8.893977,22.029697,13.272551,14.230364,12.588399,24.903136,19.156259,12.998890,12.588399,12.177907,14.640855,13.956703,31.470996,13.135720,15.051346,8.072995,21.345545,21.071884,20.935054,18.472107,12.177907,13.409381,16.556481,21.892867,20.387732,11.767416,9.167638,18.745767,20.661393,17.787954,15.325007,13.272551,11.356925,20.114072,13.819872,19.977241,24.903136,23.124341,16.830142,11.767416,17.651124,22.577019,21.619206,15.051346,34.891757,12.862059,18.608937,9.304468,17.103802,14.640855,7.115182,28.050236,5.199556,17.240633,1.094643,31.744657,18.198446,14.914516,16.830142,8.893977,16.966972,12.177907,13.135720,7.525673,10.809603,11.493755,6.294199,7.252012,11.220094,6.704691,12.862059,3.694421,11.356925,4.789065,11.904246,6.294199,9.167638,7.936164,12.862059,11.083264,7.799334,2.599778,6.020538,9.851790,7.525673,6.704691,8.483486,3.968082,7.115182,1.641965,7.662503,-1.231474,-0.273661,6.431030,1.231474,7.525673,1.368304,6.431030,-4.925895,7.115182,1.368304,-6.704691,10.399112,-0.136830,5.062725,-2.462948,-2.326117,2.326117,3.694421,6.431030,-1.778795,6.157369,-3.557591,-1.368304,2.052456,6.294199,4.515404,-3.557591,-3.557591,-1.231474,-1.641965,2.736608,7.799334,6.567860,-6.431030,-2.599778,-0.273661,-3.010269,7.662503,-1.094643,-1.094643,-2.189287,0.820983,4.789065,-7.388843,-0.410491,-1.231474,-0.273661,0.547322,0.410491,3.831252,1.505135,1.368304,-6.431030,-0.820983,-2.736608,3.147100,1.915626,1.368304,1.094643,-2.736608,-0.273661,-3.010269,0.273661,1.915626,1.778795,2.189287,-2.736608,-0.410491,-2.052456,0.273661,0.273661,-0.410491,0.957813,-2.052456,0.273661,-2.873439,-0.410491,-1.915626,-2.736608,-1.094643,-2.326117,0.273661,-0.136830,-0.957813,-0.957813,-2.736608,-0.957813,-3.147100,-0.136830,0.547322,-1.231474,-0.820983,-2.462948,-0.547322,-0.820983,0.820983,-0.547322,-1.231474,-0.957813,-0.957813,-2.599778,-3.010269,1.641965,2.462948,-3.147100,-1.505135,-1.368304,1.094643,0.136830,-1.641965,0.273661,-0.684152,-1.231474,-1.505135,1.505135,0.000000,2.599778,-0.820983,-0.410491,-0.957813,-1.368304,1.368304,0.410491,0.957813,-0.547322,0.547322,1.778795,-0.957813,0.410491,1.505135,2.052456,0.136830,-0.547322,-1.231474,1.368304,-0.957813,-1.094643,-0.410491,0.547322,-0.136830,-0.136830,0.547322,0.547322,-0.136830,0.547322,2.873439,0.136830,1.368304,-0.410491,0.957813,0.547322,-1.094643,-0.410491,-0.410491,2.189287,-1.915626,0.410491,1.094643,0.957813,-1.094643,0.273661,0.684152,2.326117,0.273661,-0.820983,-1.094643,0.136830,-2.189287,0.000000,0.000000,0.136830,-1.231474,-1.231474,0.136830,0.684152,0.000000,0.410491,0.000000,-0.136830,-0.820983,-0.547322,1.641965,0.547322,1.231474,-1.094643,-0.684152,-0.273661,0.684152,-0.684152,0.136830,-0.273661,-0.684152,-1.641965,0.000000,0.684152,1.094643,0.273661,0.273661,-0.684152,-0.273661,-0.684152,1.368304,1.094643,0.684152,-0.820983,-0.410491,0.136830,-0.273661,-0.273661,0.136830,0.273661,-0.957813,-0.820983,-1.641965,0.410491,1.368304,0.684152,0.000000,-0.410491,-0.273661,-1.368304,-1.094643,0.410491,1.641965,1.094643,-0.547322,-1.094643,0.410491,-0.136830,-0.684152,0.000000,0.410491,-0.273661,-0.136830,0.410491,-0.273661,0.410491,-0.820983,-0.684152,0.273661,0.136830,-0.410491,0.684152,0.957813,-0.136830,-0.273661,-0.684152,0.136830,0.273661,0.000000,0.410491,0.273661,0.410491,-0.410491,0.547322,0.820983,0.136830,0.000000,0.273661,0.136830,-0.136830,-0.273661,0.136830,-0.136830,0.957813,0.410491,-0.273661,-3.420760,3.283930,-0.547322,-2.052456,2.462948,0.957813,-0.410491,-2.736608,3.557591,0.957813,-2.052456,1.641965,-0.547322,0.410491,-3.283930,0.547322,0.957813,0.000000,-0.136830,-1.231474,0.957813,-0.820983,0.684152,-0.273661,0.957813,0.000000,0.000000,0.136830,-0.273661,0.000000,-0.136830,0.684152,-0.684152,-0.547322,0.273661,-0.136830,0.273661,0.547322,0.684152,-0.547322,0.000000,0.410491,0.684152,0.273661,0.273661,0.000000,-0.547322,0.136830,-0.410491,0.136830,0.684152,0.820983,0.547322,-0.410491,-0.136830,0.410491,0.136830,1.231474,0.273661,0.136830,-0.547322,0.000000,-0.136830,0.000000,-0.410491,0.547322,-0.273661,0.000000,-0.273661,-0.136830};
static float XGF_X[801]={-2.48722432,-2.34092704,-2.19462976,-2.6335216,-2.34092704,-2.48722432,-2.48722432,-2.19462976,-2.34092704,-2.04833248,-2.48722432,-2.19462976,-2.34092704,-2.34092704,-2.48722432,-2.19462976,-2.19462976,-2.48722432,-2.19462976,-2.34092704,-2.48722432,-2.34092704,-2.34092704,-2.34092704,-2.34092704,-2.48722432,-2.34092704,-2.19462976,-2.6335216,-2.34092704,-2.34092704,-2.48722432,-2.34092704,-2.48722432,-2.19462976,-2.34092704,-2.34092704,-2.34092704,-2.19462976,-2.34092704,-2.48722432,-2.34092704,-2.34092704,-2.48722432,-2.19462976,-2.19462976,-2.48722432,-2.19462976,-2.34092704,-2.19462976,-2.34092704,-2.48722432,-2.34092704,-2.48722432,-2.34092704,-2.34092704,-2.19462976,-2.34092704,-2.19462976,-2.19462976,-2.34092704,-2.34092704,-2.19462976,-2.34092704,-2.48722432,-2.34092704,-2.34092704,-2.48722432,-2.19462976,-2.34092704,-2.48722432,-2.19462976,-2.34092704,-2.34092704,-2.04833248,-2.48722432,-2.48722432,-2.04833248,-2.34092704,-2.48722432,-2.48722432,-2.34092704,-2.34092704,-2.48722432,-2.34092704,-2.34092704,-2.34092704,-2.48722432,-2.34092704,-2.48722432,-2.34092704,-2.19462976,-2.48722432,-2.48722432,-2.34092704,-2.48722432,-2.34092704,-2.48722432,-2.48722432,-2.34092704,-2.19462976,-2.48722432,-2.34092704,-2.19462976,-2.48722432,-2.34092704,-2.34092704,-2.19462976,-2.34092704,-2.19462976,-2.34092704,-2.04833248,-2.19462976,-2.48722432,-2.34092704,-2.34092704,-2.48722432,-2.19462976,-2.48722432,-2.48722432,-2.19462976,-2.48722432,-2.48722432,-2.34092704,-2.34092704,-2.34092704,-2.19462976,-2.34092704,-2.34092704,-2.34092704,-2.48722432,-2.19462976,-2.48722432,-2.34092704,-2.19462976,-2.34092704,-2.34092704,-2.34092704,-2.34092704,-2.48722432,-2.19462976,-2.48722432,-2.34092704,-2.19462976,-2.34092704,-2.34092704,-2.34092704,-2.19462976,-2.48722432,-2.48722432,-2.34092704,-2.19462976,-2.34092704,-2.48722432,-2.19462976,-2.48722432,-2.48722432,-2.19462976,-2.34092704,-2.34092704,-2.19462976,-2.19462976,-2.48722432,-2.34092704,-2.19462976,-2.34092704,-2.34092704,-2.48722432,-2.19462976,-2.34092704,-2.6335216,-2.04833248,-2.48722432,-2.34092704,-2.04833248,-2.48722432,-2.34092704,-2.19462976,-2.48722432,-2.34092704,-2.34092704,-2.34092704,-2.19462976,-2.34092704,-2.48722432,-2.19462976,-2.34092704,-2.34092704,-2.48722432,-2.34092704,-2.34092704,-2.48722432,-2.34092704,-2.19462976,-2.34092704,-2.48722432,-2.34092704,-2.48722432,-2.34092704,-2.34092704,-2.34092704,-2.34092704,-2.34092704,-2.34092704,-2.6335216,-3.07241344,-5.41316992,-13.31322304,-4.24279168,-1.75573792,-8.77800736,-5.41316992,6.72950432,-10.82616928,-17.11695232,6.72950432,-14.77619584,-20.9206816,2.19428864,-15.36138496,-14.92249312,2.63318048,-11.99654752,-14.48360128,-2.34092704,-28.08924832,-4.8279808,51.93536384,-25.60219456,-25.16330272,4.6813424,-27.06516736,-14.04470944,30.42966368,-62.90800096,-36.42819328,6.58320704,-74.02659424,-11.70395296,-8.77800736,-61.1524336,30.57596096,44.76679712,-57.4950016,-36.13559872,-38.76894976,-22.3836544,62.61506528,3.51096416,-58.37278528,-21.94476256,-36.72078784,-37.45227424,-17.994736,-9.9483856,33.50190656,5.99801792,-16.23916864,-10.97246656,-31.45408576,-28.2355456,-7.16873728,-32.624464,-4.8279808,-14.92249312,-49.00975936,-14.77619584,-11.85025024,-39.64673344,-12.58173664,-0.4390624,-15.50768224,20.92034048,24.4314752,-35.40411232,47.98533728,-4.38908896,-34.52632864,3.949856,-27.79665376,-58.51908256,0.43872128,-67.44321664,-57.93389344,-36.281896,-9.2168992,-54.13016416,-40.96340896,-35.25781504,-33.06335584,-5.26687264,-64.8098656,-22.82254624,5.85172064,-33.79484224,-38.76894976,-36.281896,-31.60038304,-37.30597696,-26.18738368,-15.8002768,-39.64673344,-18.28733056,-15.21508768,-10.82616928,-8.33911552,-19.89660064,-7.7539264,-0.00017056,-14.337304,-0.4390624,11.70361184,-16.23916864,-6.43725088,-10.53357472,-39.50043616,-17.55584416,-17.55584416,-24.43181632,-26.47997824,-26.7725728,-20.77438432,-20.1891952,-27.35776192,-29.40592384,-32.33186944,-29.99111296,-21.50587072,-28.2355456,-25.16330272,-22.3836544,-16.67806048,-12.8743312,-8.33911552,-15.8002768,-7.31503456,-10.53357472,-17.55584416,-6.58354816,-11.26506112,-6.58354816,-9.80208832,-6.2909536,-8.19281824,-11.4113584,-15.50768224,-9.36319648,-4.24279168,-4.97427808,-9.07060192,-7.16873728,-0.29276512,-5.12057536,-8.04652096,-6.14465632,-5.99835904,-0.87795424,-1.02425152,-3.95019712,-6.43725088,-3.21871072,-3.07241344,-2.92611616,-2.6335216,-2.04833248,0.14612672,1.60909952,-1.60944064,-5.85206176,1.0239104,-4.38908896,-4.38908896,-5.5594672,-15.21508768,-2.19462976,-0.29276512,-8.04652096,1.0239104,3.36466688,-7.90022368,1.90169408,-6.43725088,-2.48722432,0.43872128,-4.0964944,-4.24279168,-1.75573792,-2.48722432,3.07207232,-1.31684608,-1.46314336,-1.75573792,-3.365008,1.0239104,-1.1705488,-4.97427808,-1.02425152,1.17020768,1.31650496,-0.29276512,2.04799136,0.58501856,-1.02425152,-1.1705488,-2.77981888,-3.07241344,2.4868832,-0.00017056,2.34058592,-1.75573792,-0.87795424,0.73131584,-2.92611616,-1.46314336,-0.29276512,-2.6335216,-2.6335216,-1.60944064,0.292424,-3.07241344,-1.02425152,0.87761312,-1.60944064,-2.77981888,-2.19462976,-2.77981888,-1.9020352,-0.58535968,-2.92611616,-0.87795424,-2.34092704,-4.38908896,-1.60944064,-1.1705488,-1.75573792,1.31650496,-1.02425152,-4.0964944,-1.1705488,-2.34092704,-1.31684608,-2.6335216,-1.31684608,-2.34092704,-2.19462976,-2.04833248,-2.04833248,-0.29276512,-1.31684608,-4.38908896,-2.92611616,-4.97427808,-1.46314336,-3.07241344,-2.6335216,-2.19462976,-3.80389984,-3.07241344,-3.65760256,-3.65760256,-1.1705488,-0.87795424,-3.51130528,-2.92611616,-1.46314336,-2.77981888,-2.77981888,-1.60944064,-3.21871072,-1.46314336,-3.95019712,-2.92611616,-3.07241344,-2.48722432,-2.34092704,-1.46314336,-2.19462976,-2.19462976,-2.48722432,-2.92611616,-2.92611616,-2.77981888,-1.60944064,-0.29276512,-2.19462976,-1.1705488,-1.46314336,-1.46314336,-2.92611616,-2.77981888,-1.02425152,-2.77981888,-1.9020352,-2.77981888,-2.48722432,-2.19462976,-3.07241344,-2.92611616,-1.9020352,-3.21871072,-2.48722432,-1.60944064,-1.31684608,-1.1705488,-1.60944064,-1.1705488,-1.75573792,-1.46314336,-2.04833248,-2.34092704,-3.21871072,-1.46314336,-1.9020352,-1.9020352,-2.77981888,-2.34092704,-2.04833248,-1.9020352,-2.34092704,-2.19462976,-2.04833248,-1.60944064,-1.60944064,-2.48722432,-1.1705488,-3.21871072,-2.92611616,-2.04833248,-3.07241344,-3.07241344,-2.6335216,-2.34092704,-1.60944064,-1.60944064,-2.92611616,-2.04833248,-1.60944064,-2.48722432,-2.34092704,-2.04833248,-1.31684608,-2.92611616,-3.65760256,-2.6335216,-2.48722432,-2.77981888,-2.19462976,-2.48722432,-1.9020352,-1.9020352,-1.60944064,-1.9020352,-1.46314336,-2.19462976,-2.34092704,-2.48722432,-3.365008,-1.9020352,-2.04833248,-2.04833248,-2.04833248,-2.19462976,-2.48722432,-3.07241344,-1.9020352,-1.9020352,-1.60944064,-0.29276512,-3.365008,-1.46314336,-1.46314336,-3.07241344,-2.04833248,-2.04833248,-1.75573792,-1.9020352,-1.9020352,-1.75573792,-1.9020352,-2.34092704,-2.92611616,-1.9020352,-1.60944064,-1.02425152,-3.51130528,-2.6335216,-2.77981888,-1.60944064,-1.31684608,-1.46314336,-3.07241344,-1.9020352,-1.46314336,-2.6335216,-1.75573792,-2.19462976,-1.60944064,-2.04833248,-2.34092704,-1.9020352,-2.48722432,-2.6335216,-1.46314336,-2.04833248,-1.9020352,-2.34092704,-2.77981888,-2.04833248,-2.19462976,-2.19462976,-2.34092704,-2.48722432,-2.48722432,-2.19462976,-2.48722432,-2.48722432,-2.04833248,-1.9020352,-2.19462976,-2.04833248,-2.04833248,-2.34092704,-2.19462976,-2.6335216,-2.92611616,-3.07241344,-2.04833248,-2.34092704,-2.77981888,-2.6335216,-2.92611616,-2.19462976,-1.9020352,-2.92611616,-2.34092704,-2.77981888,-3.07241344,-2.48722432,-2.77981888,-2.34092704,-2.19462976,-2.48722432,-2.77981888,-2.34092704,-2.48722432,-2.77981888,-2.77981888,-2.48722432,-2.6335216,-2.34092704,-2.19462976,-2.48722432,-2.19462976,-1.9020352,-2.48722432,-2.19462976,-2.34092704,-2.04833248,-2.04833248,-1.9020352,-2.48722432,-2.34092704,-2.77981888,-2.34092704,-2.48722432,-2.34092704,-2.48722432,-2.19462976,-2.77981888,-2.6335216,-2.77981888,-2.48722432,-2.6335216,-2.48722432,-2.48722432,-2.19462976,-2.19462976,-2.34092704,-2.48722432,-2.48722432,-2.48722432,-2.04833248,-2.48722432,-2.48722432,-2.48722432,-2.34092704,-2.34092704,-2.48722432,-2.6335216,-2.6335216,-2.19462976,-2.34092704,-2.48722432,-2.34092704,-1.9020352,-2.04833248,-2.19462976,-2.19462976,-2.19462976,-2.19462976,-2.48722432,-2.48722432,-2.6335216,-2.48722432,-2.34092704,-2.6335216,-2.6335216,-2.34092704,-2.48722432,-2.77981888,-2.6335216,-2.6335216,-2.6335216,-2.77981888,-2.34092704,-2.6335216,-2.34092704,-2.77981888,-2.6335216,-2.6335216,-2.6335216,-2.6335216,-2.34092704,-2.34092704,-2.34092704,-2.34092704,-2.48722432,-2.48722432,-2.34092704,-2.48722432,-2.04833248,-2.04833248,-2.19462976,-2.34092704,-2.48722432,-2.48722432,-2.48722432,-2.48722432,-2.48722432,-2.34092704,-2.34092704,-2.34092704,-2.34092704,-2.48722432,-2.34092704,-2.48722432,-2.92611616,-2.34092704,-2.48722432,-2.04833248,-2.04833248,-2.34092704,-2.34092704,-2.48722432,-2.48722432,-2.48722432,-2.48722432,-2.19462976,-2.19462976,-2.19462976,-2.34092704,-2.48722432,-2.48722432,-2.34092704,-2.34092704,-2.04833248,-2.34092704,-2.19462976,-2.48722432,-2.48722432,-2.48722432,-2.6335216,-2.34092704,-2.77981888,-2.34092704,-2.77981888,-2.34092704,-2.19462976,-2.19462976,-2.48722432,-2.48722432,-2.48722432,-2.19462976,-2.34092704,-2.48722432,-2.48722432,-2.48722432,-2.19462976,-2.34092704,-2.04833248,-2.48722432,-2.48722432,-2.6335216,-2.6335216,-2.48722432,-2.48722432,-2.34092704,-2.19462976,-2.19462976,-2.48722432,-2.34092704};
static float XGF_Y[801]={-0.58328928,-0.87490592,-1.02071424,-0.58328928,-0.72909760,-0.72909760,-0.72909760,-0.72909760,-0.58328928,-0.72909760,-0.72909760,-0.58328928,-0.87490592,-0.58328928,-0.58328928,-0.72909760,-0.72909760,-0.58328928,-0.58328928,-0.43748096,-0.43748096,-0.87490592,-0.43748096,-0.72909760,-0.72909760,-0.58328928,-0.72909760,-0.72909760,-0.58328928,-0.43748096,-0.87490592,-0.72909760,-0.87490592,-0.72909760,-0.43748096,-0.87490592,-0.72909760,-0.72909760,-0.72909760,-0.72909760,-0.43748096,-0.87490592,-0.72909760,-0.58328928,-0.58328928,-0.58328928,-0.72909760,-0.58328928,-0.58328928,-0.72909760,-0.58328928,-0.58328928,-0.87490592,-0.58328928,-0.72909760,-0.72909760,-0.43748096,-0.72909760,-0.58328928,-0.72909760,-0.58328928,-0.72909760,-0.87490592,-0.72909760,-0.72909760,-0.58328928,-0.58328928,-0.58328928,-0.72909760,-0.72909760,-0.58328928,-0.58328928,-0.87490592,-0.43748096,-0.87490592,-0.58328928,-0.72909760,-0.87490592,-0.72909760,-0.72909760,-0.87490592,-0.72909760,-0.72909760,-0.72909760,-0.58328928,-0.87490592,-0.72909760,-0.72909760,-0.72909760,-0.58328928,-0.72909760,-0.72909760,-0.72909760,-0.58328928,-0.58328928,-0.72909760,-0.72909760,-0.58328928,-0.72909760,-0.72909760,-0.72909760,-0.72909760,-0.72909760,-0.58328928,-0.72909760,-0.72909760,-0.58328928,-0.72909760,-0.58328928,-0.72909760,-0.58328928,-0.87490592,-0.72909760,-0.29167264,-0.87490592,-0.87490592,-0.58328928,-0.72909760,-0.72909760,-0.43748096,-0.87490592,-0.58328928,-0.43748096,-0.72909760,-0.58328928,-0.72909760,-0.72909760,-0.58328928,-0.58328928,-0.72909760,-0.58328928,-0.72909760,-0.58328928,-0.43748096,-0.72909760,-0.72909760,-0.58328928,-0.58328928,-0.72909760,-0.58328928,-0.87490592,-0.43748096,-0.72909760,-0.72909760,-0.58328928,-0.87490592,-0.43748096,-0.58328928,-0.58328928,-0.58328928,-0.72909760,-0.72909760,-0.87490592,-0.43748096,-0.87490592,-0.72909760,-0.43748096,-0.72909760,-0.72909760,-0.58328928,-0.72909760,-0.87490592,-0.58328928,-0.72909760,-0.72909760,-0.43748096,-1.02071424,-0.58328928,-0.87490592,-0.87490592,-0.43748096,-0.87490592,-0.72909760,-0.58328928,-0.87490592,-0.58328928,-0.58328928,-0.87490592,-0.58328928,-0.87490592,-0.58328928,-0.58328928,-0.72909760,-0.43748096,-0.87490592,-0.72909760,-0.43748096,-0.87490592,-0.72909760,-0.29167264,-0.87490592,-0.58328928,-0.58328928,-0.87490592,-0.58328928,-0.72909760,-0.58328928,-0.72909760,-0.72909760,-0.72909760,-0.58328928,-0.43748096,-0.87490592,-0.58328928,-0.43748096,0.29156064,3.79096032,13.26850112,-0.43748096,5.97808512,3.93676864,-6.70723872,-7.43628032,8.16520992,17.05951744,-14.72669632,24.34993344,16.62209248,-7.58208864,15.16400928,22.60023360,-3.79107232,14.58077600,16.47628416,22.16280864,34.41070752,-2.18718080,-29.45333664,36.88944896,-4.66592224,-16.33058784,13.41430944,11.51880128,30.18226624,80.48613664,35.28555744,17.78855904,36.88944896,23.18346688,-9.33178848,26.68286656,37.18106560,-40.38896064,63.42656320,14.58077600,34.26489920,31.20292448,-3.93688064,52.63674752,57.74003872,10.93556800,2.47868544,1.16641056,-12.53957152,50.59543104,43.45082336,7.14455168,16.62209248,-3.93688064,53.36578912,20.70472544,19.39245056,57.15680544,24.49574176,56.13614720,22.01700032,12.97688448,14.87239264,52.19932256,-5.24915552,14.87239264,21.57957536,41.84693184,-21.57968736,-4.95753888,-15.89316288,7.58197664,36.01459904,-41.84704384,37.03525728,21.28795872,43.45082336,15.30981760,-19.39256256,76.98673696,5.10323520,87.04751104,19.68406720,19.97568384,38.49334048,-18.80932928,21.28795872,12.24784288,33.53585760,-5.39496384,6.70712672,17.49694240,23.76670016,37.76429888,36.74364064,1.60383552,36.59783232,3.79096032,15.60143424,20.99634208,15.16400928,15.45562592,30.18226624,1.31221888,28.28675808,19.68406720,20.55891712,32.95262432,27.26609984,7.43616832,29.30741632,24.49574176,21.28795872,29.16160800,10.78975968,20.55891712,8.60263488,21.14215040,12.10203456,10.20652640,3.35353536,4.37419360,9.91490976,8.89425152,12.53945952,-5.24915552,22.30861696,8.60263488,13.70592608,1.31221888,2.91611040,12.68526784,-2.04137248,5.83227680,-3.49945568,7.14455168,9.62329312,6.56131840,5.54066016,-2.91622240,3.20772704,6.41551008,-1.31233088,4.52000192,-2.62460576,5.68646848,7.58197664,-0.72909760,9.91490976,-3.20783904,8.16520992,4.37419360,-1.60394752,4.95742688,-3.35364736,6.85293504,2.62449376,0.29156064,4.95742688,-4.37430560,12.97688448,-0.72909760,-1.45813920,0.14575232,-0.87490592,6.70712672,-0.00005600,-1.60394752,1.60383552,-3.20783904,1.02060224,4.08257696,-1.74975584,1.74964384,0.72898560,1.16641056,-0.43748096,0.87479392,-3.79107232,2.33287712,-2.47879744,2.33287712,2.91611040,-3.35364736,2.62449376,-0.72909760,-2.47879744,-1.02071424,1.74964384,-4.22849728,1.60383552,-1.31233088,-6.85304704,-0.14586432,-6.41562208,0.29156064,-5.97819712,-3.06203072,-1.45813920,-8.16532192,0.87479392,-4.95753888,1.74964384,-2.33298912,0.58317728,0.72898560,-2.91622240,0.58317728,0.87479392,2.04126048,-1.74975584,-0.43748096,-3.35364736,0.14575232,-1.16652256,-1.74975584,-1.16652256,0.14575232,-2.04137248,-3.79107232,-0.87490592,-2.91622240,1.16641056,-1.89556416,-1.02071424,-3.93688064,0.14575232,-1.02071424,-1.74975584,2.62449376,-0.87490592,-1.74975584,2.33287712,-3.49945568,-0.29167264,0.43736896,-2.04137248,0.29156064,0.72898560,2.04126048,-2.18718080,2.04126048,0.29156064,1.74964384,-1.02071424,-1.02071424,-2.18718080,-0.43748096,1.31221888,1.60383552,-0.87490592,1.60383552,-1.60394752,-0.43748096,-0.29167264,-0.14586432,0.87479392,-0.29167264,0.43736896,-1.60394752,-0.00005600,-0.87490592,-2.33298912,-0.00005600,-1.89556416,-0.00005600,-0.72909760,-0.43748096,1.45802720,1.02060224,0.29156064,0.58317728,1.16641056,-0.72909760,-0.43748096,-1.31233088,0.14575232,-0.58328928,-1.31233088,-1.02071424,0.29156064,-0.72909760,-2.04137248,-0.00005600,-1.02071424,-0.72909760,-1.02071424,-1.31233088,-1.60394752,-0.00005600,-0.72909760,-0.87490592,-1.89556416,-1.45813920,-1.02071424,-1.16652256,-0.00005600,-2.04137248,-0.58328928,-0.43748096,-1.31233088,-1.60394752,-2.77041408,-1.45813920,-1.31233088,-1.60394752,-1.74975584,-0.72909760,-1.31233088,-1.16652256,-0.43748096,-0.43748096,-0.00005600,-1.45813920,0.58317728,1.16641056,0.14575232,-0.72909760,0.58317728,0.72898560,-1.16652256,-0.58328928,-2.18718080,0.29156064,-1.16652256,-2.04137248,0.14575232,-0.43748096,-0.29167264,-0.58328928,-1.02071424,0.58317728,-0.14586432,0.14575232,-0.29167264,-0.87490592,-0.87490592,-0.87490592,-0.87490592,-0.72909760,-0.00005600,-0.29167264,0.58317728,0.87479392,0.14575232,0.72898560,-1.02071424,0.58317728,0.14575232,-1.60394752,-1.02071424,-0.58328928,-0.14586432,-0.29167264,-0.29167264,0.14575232,-0.43748096,0.58317728,-0.72909760,-1.45813920,1.02060224,-0.14586432,-0.14586432,-0.72909760,-0.58328928,-1.89556416,-0.00005600,-1.60394752,-0.72909760,-0.14586432,-0.72909760,0.14575232,-0.14586432,0.29156064,0.14575232,-0.72909760,-0.00005600,-0.72909760,-0.29167264,-0.87490592,-1.60394752,-0.87490592,0.14575232,-0.72909760,-0.43748096,-1.45813920,-0.58328928,-1.45813920,-0.87490592,-0.87490592,-0.29167264,-0.00005600,-0.87490592,-0.72909760,-0.87490592,-0.58328928,-0.29167264,-0.72909760,-0.43748096,-0.29167264,-0.72909760,-0.00005600,-0.29167264,0.14575232,-0.14586432,-0.00005600,-0.43748096,-0.00005600,-0.87490592,-0.14586432,-0.29167264,-0.29167264,-0.29167264,0.29156064,-0.00005600,0.29156064,0.14575232,-0.72909760,-0.14586432,-0.43748096,-0.29167264,-0.72909760,-0.14586432,-0.00005600,-0.58328928,-0.87490592,-0.43748096,-1.02071424,-0.29167264,-0.72909760,-0.00005600,-0.58328928,-0.58328928,0.29156064,0.14575232,-0.43748096,-0.72909760,-0.29167264,-0.72909760,-0.29167264,-0.58328928,-0.58328928,-1.02071424,-0.87490592,-0.14586432,-0.72909760,-0.29167264,-0.43748096,-0.87490592,-0.14586432,-0.87490592,-0.72909760,-0.43748096,-0.72909760,-0.43748096,-0.58328928,-0.72909760,-0.72909760,-0.29167264,-0.43748096,-0.14586432,-0.43748096,-0.72909760,-0.43748096,-0.14586432,-0.58328928,-0.87490592,-0.87490592,-0.72909760,-0.72909760,-0.58328928,-0.87490592,-0.43748096,-0.72909760,-0.43748096,-0.58328928,-0.58328928,-0.43748096,-0.58328928,-0.43748096,-0.29167264,-0.29167264,-0.29167264,-0.72909760,-0.43748096,-0.58328928,-0.43748096,-0.58328928,-0.14586432,-0.29167264,-0.58328928,-0.29167264,-0.14586432,-0.14586432,-0.72909760,-0.72909760,-0.43748096,-0.58328928,-0.43748096,-0.58328928,-0.58328928,-0.29167264,-0.58328928,-0.43748096,-0.72909760,-0.43748096,-0.43748096,-0.43748096,-0.58328928,-0.72909760,-0.43748096,-0.43748096,-0.43748096,-0.72909760,-0.87490592,-0.72909760,-0.43748096,-0.00005600,-0.00005600,-0.58328928,-0.00005600,-0.29167264,-0.43748096,-0.43748096,-0.58328928,-0.29167264,-0.58328928,-0.29167264,-0.87490592,-0.58328928,-0.87490592,-0.87490592,-0.58328928,-0.58328928,-0.43748096,-0.58328928,-0.72909760,-0.58328928,-0.43748096,-0.58328928,-0.72909760,-1.02071424,-0.87490592,-0.87490592,-0.29167264,-0.72909760,-0.58328928,-0.43748096,-0.58328928,-0.29167264,-0.87490592,-1.02071424,-0.72909760,-0.43748096,-0.43748096,-0.87490592,-0.43748096,-0.43748096,-0.72909760,-0.72909760,-0.72909760,-0.43748096,-0.87490592,-0.72909760,-0.87490592,-0.58328928,-0.43748096,-0.72909760,-0.72909760,-0.72909760,-1.16652256,-0.58328928,-0.87490592,-0.43748096,-0.72909760,-0.87490592,-0.58328928,-0.58328928,-0.58328928,-0.87490592,-0.58328928,-0.72909760,-0.72909760,-0.43748096,-0.72909760,-0.43748096,-1.02071424,-1.02071424,-0.72909760,-0.87490592,-0.72909760,-0.87490592,-0.72909760,-0.29167264,-0.58328928,-0.72909760};	
const uint8_t Request0x0cmd[]={0x10,0x00,0x00,0x0d};
const uint8_t Request0x2cmd[]={0x50,0x00,0x00,0xfc};
double timeX=-100.5,timeY=-100.5;
uint8_t RCOMMAND0x00=0b10000100;
uint8_t RCOMMAND0x02=0b10100100;
static uint32_t ctr2=0;
static uint32_t ctr0=0;
volatile bool SPI_STOP_FLAG=false;
/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_FDCAN1_Init(void);
static void MX_UART4_Init(void);
static void MX_TIM1_Init(void);
static void MX_SPI3_Init(void);
void Init_test_run(void *argument);
void CAN_2_RUN(void *argument);
void Accelerometer1_RUN(void *argument);

/* USER CODE BEGIN PFP */
static void FDCAN1_Config(void);
static uint32_t buffer_average_value(uint32_t *buffer_to_evaluate,uint8_t size);
static uint8_t CRC8(uint32_t SPI_data);
static uint32_t form_acc(float acceleration,bool axis);
/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */
void HAL_SPI_TxRxCpltCallback(SPI_HandleTypeDef *hspi)
{
  if(hspi == &hspi3)
  {
		float *acceleration_X_ptr,*acceleration_Y_ptr;
		if(UARTRXcmd[0]==0x03)
		{
			acceleration_X_ptr=XGE_X;
			acceleration_Y_ptr=XGE_Y;
		}
		else if(UARTRXcmd[0]==0x04)
		{
			acceleration_X_ptr=XGF_X;
			acceleration_Y_ptr=XGF_Y;
		}
		uint32_t acceleration_32;
    if(memcmp(SPI_RXbuf,Request0x0cmd,4)==0)
    { 
       acceleration_32=form_acc(*(acceleration_X_ptr+ctr0),X);
       timeX+=0.5;
       SPI_resp[0]=acceleration_32>>24;
       SPI_resp[1]=acceleration_32>>16;
       SPI_resp[2]=acceleration_32>>8;
       SPI_resp[3]=acceleration_32;
       ctr0+=1;
    }
		else if (memcmp(SPI_RXbuf,Request0x2cmd,4)==0)
    { 
       acceleration_32=form_acc(*(acceleration_Y_ptr+ctr2),Y);
       timeY+=0.5;
       SPI_resp[0]=acceleration_32>>24;
       SPI_resp[1]=acceleration_32>>16;
       SPI_resp[2]=acceleration_32>>8;
       SPI_resp[3]=acceleration_32;    
       ctr2+=1;		 
    }
  }
}
void HAL_FDCAN_RxFifo0Callback(FDCAN_HandleTypeDef *hfdcan, uint32_t RxFifo0ITs)
{
	uint8_t RxData[8]={0,};
  if((RxFifo0ITs & FDCAN_IT_RX_FIFO0_NEW_MESSAGE) != RESET)
  {
		//implementation for the first test which measures the launching time
		//measures and transmits the time between reception of the UART command to launch test
		//and first received CAN message
		if(UARTRXcmd[0]==0x01)
      {
				 uint8_t result1[4];
			   UARTRXcmd[0]=0x00;
         if (HAL_FDCAN_GetRxMessage(hfdcan, FDCAN_RX_FIFO0, &RxHeader, RxData) == HAL_OK)
           {
             timelist[0]=time;
						 result1[0]=timelist[0]>>24;				
						 result1[1]=timelist[0]>>16;		
						 result1[2]=timelist[0]>>8;			
             result1[3]=timelist[0];             					 
           }
         HAL_UART_Transmit(&huart4,result1,4,0);					 
	    }
		/*There is the implementation of a second test, which measures the period of 0x653 CAN message.
		  Those message is being received 50 times, time interval between two consequent messages is being measured every time
			then the average period is being calculated and transmitted via UART*/
	  else if(UARTRXcmd[0]==0x02)
      {
				uint8_t result2[4];
				uint32_t average;
				static uint8_t RXcounter=0;
			  if(RXcounter==49)
				{ 
					 UARTRXcmd[0]=0x00;
					 average=buffer_average_value(timelist,50);
					 result2[0]=average>>24;				
					 result2[1]=average>>16;		
					 result2[2]=average>>8;			
           result2[3]=average;
					 HAL_UART_Transmit(&huart4,result2,4,10);	
				}			
		     if (HAL_FDCAN_GetRxMessage(hfdcan, FDCAN_RX_FIFO0, &RxHeader, RxData) == HAL_OK)
           {
             timelist[RXcounter]=time;
				     RXcounter++; 
             time=0;    				 
           }
	    }
		else __NOP();	    
  }
}
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
	/*Handles CH0 rising edge interrupt(when crash occurs)*/
	if(GPIO_Pin==CH4_Pin || GPIO_Pin==CH2_Pin)//
	{
		HAL_GPIO_WritePin(POWER_GOOD_GPIO_Port,POWER_GOOD_Pin,GPIO_PIN_RESET);
		SPI_STOP_FLAG=true;
		HAL_GPIO_WritePin(RED_LED_GPIO_Port,RED_LED_Pin,GPIO_PIN_SET);
		//TTF=time;
		//HAL_UART_Transmit
	}
}
/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{
  /* USER CODE BEGIN 1 */

  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_FDCAN1_Init();
  MX_UART4_Init();
  MX_TIM1_Init();
  MX_SPI3_Init();
  /* USER CODE BEGIN 2 */
  FDCAN1_Config();
	HAL_TIM_Base_Start_IT(&htim1);
  /* USER CODE END 2 */

  /* Init scheduler */
  osKernelInitialize();

  /* USER CODE BEGIN RTOS_MUTEX */
  /* add mutexes, ... */
  /* USER CODE END RTOS_MUTEX */

  /* USER CODE BEGIN RTOS_SEMAPHORES */
  /* add semaphores, ... */
  /* USER CODE END RTOS_SEMAPHORES */

  /* USER CODE BEGIN RTOS_TIMERS */
  /* start timers, add new ones, ... */
  /* USER CODE END RTOS_TIMERS */

  /* USER CODE BEGIN RTOS_QUEUES */
  /* add queues, ... */
  /* USER CODE END RTOS_QUEUES */

  /* Create the thread(s) */
  /* creation of Init_test */
  Init_testHandle = osThreadNew(Init_test_run, NULL, &Init_test_attributes);

  /* creation of CAN_period */
  CAN_periodHandle = osThreadNew(CAN_2_RUN, NULL, &CAN_period_attributes);

  /* creation of Accelerometer_run */
  Accelerometer_runHandle = osThreadNew(Accelerometer1_RUN, NULL, &Accelerometer_run_attributes);

  /* USER CODE BEGIN RTOS_THREADS */
  /* add threads, ... */
  /* USER CODE END RTOS_THREADS */

  /* USER CODE BEGIN RTOS_EVENTS */
  /* add events, ... */
  /* USER CODE END RTOS_EVENTS */

  /* Start scheduler */
  osKernelStart();

  /* We should never get here as control is now taken by the scheduler */
  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  while (1)
  {
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */
  }
  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};

  /** Supply configuration update enable
  */
  HAL_PWREx_ConfigSupply(PWR_LDO_SUPPLY);

  /** Configure the main internal regulator output voltage
  */
  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE1);

  while(!__HAL_PWR_GET_FLAG(PWR_FLAG_VOSRDY)) {}

  __HAL_RCC_SYSCFG_CLK_ENABLE();
  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE0);

  while(!__HAL_PWR_GET_FLAG(PWR_FLAG_VOSRDY)) {}

  /** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSI;
  RCC_OscInitStruct.HSIState = RCC_HSI_DIV1;
  RCC_OscInitStruct.HSICalibrationValue = RCC_HSICALIBRATION_DEFAULT;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSI;
  RCC_OscInitStruct.PLL.PLLM = 4;
  RCC_OscInitStruct.PLL.PLLN = 60;
  RCC_OscInitStruct.PLL.PLLP = 2;
  RCC_OscInitStruct.PLL.PLLQ = 8;
  RCC_OscInitStruct.PLL.PLLR = 2;
  RCC_OscInitStruct.PLL.PLLRGE = RCC_PLL1VCIRANGE_3;
  RCC_OscInitStruct.PLL.PLLVCOSEL = RCC_PLL1VCOWIDE;
  RCC_OscInitStruct.PLL.PLLFRACN = 0;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }

  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2
                              |RCC_CLOCKTYPE_D3PCLK1|RCC_CLOCKTYPE_D1PCLK1;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.SYSCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_HCLK_DIV2;
  RCC_ClkInitStruct.APB3CLKDivider = RCC_APB3_DIV2;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_APB1_DIV2;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_APB2_DIV2;
  RCC_ClkInitStruct.APB4CLKDivider = RCC_APB4_DIV2;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_4) != HAL_OK)
  {
    Error_Handler();
  }
}

/**
  * @brief FDCAN1 Initialization Function
  * @param None
  * @retval None
  */
static void MX_FDCAN1_Init(void)
{

  /* USER CODE BEGIN FDCAN1_Init 0 */

  /* USER CODE END FDCAN1_Init 0 */

  /* USER CODE BEGIN FDCAN1_Init 1 */

  /* USER CODE END FDCAN1_Init 1 */
  hfdcan1.Instance = FDCAN1;
  hfdcan1.Init.FrameFormat = FDCAN_FRAME_CLASSIC;
  hfdcan1.Init.Mode = FDCAN_MODE_NORMAL;
  hfdcan1.Init.AutoRetransmission = ENABLE;
  hfdcan1.Init.TransmitPause = DISABLE;
  hfdcan1.Init.ProtocolException = DISABLE;
  hfdcan1.Init.NominalPrescaler = 15;
  hfdcan1.Init.NominalSyncJumpWidth = 1;
  hfdcan1.Init.NominalTimeSeg1 = 13;
  hfdcan1.Init.NominalTimeSeg2 = 2;
  hfdcan1.Init.DataPrescaler = 1;
  hfdcan1.Init.DataSyncJumpWidth = 1;
  hfdcan1.Init.DataTimeSeg1 = 1;
  hfdcan1.Init.DataTimeSeg2 = 1;
  hfdcan1.Init.MessageRAMOffset = 0;
  hfdcan1.Init.StdFiltersNbr = 0;
  hfdcan1.Init.ExtFiltersNbr = 0;
  hfdcan1.Init.RxFifo0ElmtsNbr = 50;
  hfdcan1.Init.RxFifo0ElmtSize = FDCAN_DATA_BYTES_8;
  hfdcan1.Init.RxFifo1ElmtsNbr = 0;
  hfdcan1.Init.RxFifo1ElmtSize = FDCAN_DATA_BYTES_8;
  hfdcan1.Init.RxBuffersNbr = 0;
  hfdcan1.Init.RxBufferSize = FDCAN_DATA_BYTES_8;
  hfdcan1.Init.TxEventsNbr = 0;
  hfdcan1.Init.TxBuffersNbr = 1;
  hfdcan1.Init.TxFifoQueueElmtsNbr = 20;
  hfdcan1.Init.TxFifoQueueMode = FDCAN_TX_FIFO_OPERATION;
  hfdcan1.Init.TxElmtSize = FDCAN_DATA_BYTES_8;
  if (HAL_FDCAN_Init(&hfdcan1) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN FDCAN1_Init 2 */

  /* USER CODE END FDCAN1_Init 2 */

}

/**
  * @brief SPI3 Initialization Function
  * @param None
  * @retval None
  */
static void MX_SPI3_Init(void)
{

  /* USER CODE BEGIN SPI3_Init 0 */

  /* USER CODE END SPI3_Init 0 */

  /* USER CODE BEGIN SPI3_Init 1 */

  /* USER CODE END SPI3_Init 1 */
  /* SPI3 parameter configuration*/
  hspi3.Instance = SPI3;
  hspi3.Init.Mode = SPI_MODE_SLAVE;
  hspi3.Init.Direction = SPI_DIRECTION_2LINES;
  hspi3.Init.DataSize = SPI_DATASIZE_8BIT;
  hspi3.Init.CLKPolarity = SPI_POLARITY_LOW;
  hspi3.Init.CLKPhase = SPI_PHASE_1EDGE;
  hspi3.Init.NSS = SPI_NSS_SOFT;
  hspi3.Init.FirstBit = SPI_FIRSTBIT_MSB;
  hspi3.Init.TIMode = SPI_TIMODE_DISABLE;
  hspi3.Init.CRCCalculation = SPI_CRCCALCULATION_DISABLE;
  hspi3.Init.CRCPolynomial = 0x0;
  hspi3.Init.NSSPMode = SPI_NSS_PULSE_DISABLE;
  hspi3.Init.NSSPolarity = SPI_NSS_POLARITY_LOW;
  hspi3.Init.FifoThreshold = SPI_FIFO_THRESHOLD_01DATA;
  hspi3.Init.TxCRCInitializationPattern = SPI_CRC_INITIALIZATION_ALL_ZERO_PATTERN;
  hspi3.Init.RxCRCInitializationPattern = SPI_CRC_INITIALIZATION_ALL_ZERO_PATTERN;
  hspi3.Init.MasterSSIdleness = SPI_MASTER_SS_IDLENESS_00CYCLE;
  hspi3.Init.MasterInterDataIdleness = SPI_MASTER_INTERDATA_IDLENESS_00CYCLE;
  hspi3.Init.MasterReceiverAutoSusp = SPI_MASTER_RX_AUTOSUSP_DISABLE;
  hspi3.Init.MasterKeepIOState = SPI_MASTER_KEEP_IO_STATE_DISABLE;
  hspi3.Init.IOSwap = SPI_IO_SWAP_DISABLE;
  if (HAL_SPI_Init(&hspi3) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN SPI3_Init 2 */

  /* USER CODE END SPI3_Init 2 */

}

/**
  * @brief TIM1 Initialization Function
  * @param None
  * @retval None
  */
static void MX_TIM1_Init(void)
{

  /* USER CODE BEGIN TIM1_Init 0 */

  /* USER CODE END TIM1_Init 0 */

  TIM_ClockConfigTypeDef sClockSourceConfig = {0};
  TIM_MasterConfigTypeDef sMasterConfig = {0};

  /* USER CODE BEGIN TIM1_Init 1 */

  /* USER CODE END TIM1_Init 1 */
  htim1.Instance = TIM1;
  htim1.Init.Prescaler = 119;
  htim1.Init.CounterMode = TIM_COUNTERMODE_UP;
  htim1.Init.Period = 100;
  htim1.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
  htim1.Init.RepetitionCounter = 0;
  htim1.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
  if (HAL_TIM_Base_Init(&htim1) != HAL_OK)
  {
    Error_Handler();
  }
  sClockSourceConfig.ClockSource = TIM_CLOCKSOURCE_INTERNAL;
  if (HAL_TIM_ConfigClockSource(&htim1, &sClockSourceConfig) != HAL_OK)
  {
    Error_Handler();
  }
  sMasterConfig.MasterOutputTrigger = TIM_TRGO_RESET;
  sMasterConfig.MasterOutputTrigger2 = TIM_TRGO2_RESET;
  sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
  if (HAL_TIMEx_MasterConfigSynchronization(&htim1, &sMasterConfig) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN TIM1_Init 2 */

  /* USER CODE END TIM1_Init 2 */

}

/**
  * @brief UART4 Initialization Function
  * @param None
  * @retval None
  */
static void MX_UART4_Init(void)
{

  /* USER CODE BEGIN UART4_Init 0 */

  /* USER CODE END UART4_Init 0 */

  /* USER CODE BEGIN UART4_Init 1 */

  /* USER CODE END UART4_Init 1 */
  huart4.Instance = UART4;
  huart4.Init.BaudRate = 115200;
  huart4.Init.WordLength = UART_WORDLENGTH_8B;
  huart4.Init.StopBits = UART_STOPBITS_1;
  huart4.Init.Parity = UART_PARITY_NONE;
  huart4.Init.Mode = UART_MODE_TX_RX;
  huart4.Init.HwFlowCtl = UART_HWCONTROL_NONE;
  huart4.Init.OverSampling = UART_OVERSAMPLING_16;
  huart4.Init.OneBitSampling = UART_ONE_BIT_SAMPLE_DISABLE;
  huart4.Init.ClockPrescaler = UART_PRESCALER_DIV1;
  huart4.AdvancedInit.AdvFeatureInit = UART_ADVFEATURE_NO_INIT;
  if (HAL_UART_Init(&huart4) != HAL_OK)
  {
    Error_Handler();
  }
  if (HAL_UARTEx_SetTxFifoThreshold(&huart4, UART_TXFIFO_THRESHOLD_1_8) != HAL_OK)
  {
    Error_Handler();
  }
  if (HAL_UARTEx_SetRxFifoThreshold(&huart4, UART_RXFIFO_THRESHOLD_1_8) != HAL_OK)
  {
    Error_Handler();
  }
  if (HAL_UARTEx_DisableFifoMode(&huart4) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN UART4_Init 2 */

  /* USER CODE END UART4_Init 2 */

}

/**
  * @brief GPIO Initialization Function
  * @param None
  * @retval None
  */
static void MX_GPIO_Init(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};
/* USER CODE BEGIN MX_GPIO_Init_1 */
/* USER CODE END MX_GPIO_Init_1 */

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOA_CLK_ENABLE();
  __HAL_RCC_GPIOB_CLK_ENABLE();
  __HAL_RCC_GPIOC_CLK_ENABLE();
  __HAL_RCC_GPIOD_CLK_ENABLE();
  __HAL_RCC_GPIOE_CLK_ENABLE();

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(CAN_LED_GPIO_Port, CAN_LED_Pin, GPIO_PIN_RESET);

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(GPIOB, GREEN_LED_Pin|RED_LED_Pin|POWER_GOOD_Pin, GPIO_PIN_RESET);

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(YELLOW_LED_GPIO_Port, YELLOW_LED_Pin, GPIO_PIN_RESET);

  /*Configure GPIO pin : CAN_LED_Pin */
  GPIO_InitStruct.Pin = CAN_LED_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(CAN_LED_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pins : GREEN_LED_Pin RED_LED_Pin POWER_GOOD_Pin */
  GPIO_InitStruct.Pin = GREEN_LED_Pin|RED_LED_Pin|POWER_GOOD_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(GPIOB, &GPIO_InitStruct);

  /*Configure GPIO pins : CH4_Pin CH2_Pin */
  GPIO_InitStruct.Pin = CH4_Pin|CH2_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING;
  GPIO_InitStruct.Pull = GPIO_PULLDOWN;
  HAL_GPIO_Init(GPIOD, &GPIO_InitStruct);

  /*Configure GPIO pin : YELLOW_LED_Pin */
  GPIO_InitStruct.Pin = YELLOW_LED_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(YELLOW_LED_GPIO_Port, &GPIO_InitStruct);

  /* EXTI interrupt init*/
  HAL_NVIC_SetPriority(EXTI1_IRQn, 5, 0);
  HAL_NVIC_EnableIRQ(EXTI1_IRQn);

/* USER CODE BEGIN MX_GPIO_Init_2 */
/* USER CODE END MX_GPIO_Init_2 */
}

/* USER CODE BEGIN 4 */
static uint8_t CRC8(uint32_t SPI_data)
{
	uint64_t mask = MAX_UINT64_T - MAX_CRC;
	uint64_t rem = (uint64_t)((((uint64_t)SPI_data) | (((uint64_t)CRC_SEED) << MSG_LEN)) & mask);
	uint64_t divider = ((uint64_t)CRC_POLY) << (MSG_LEN - 1);

	for (uint16_t i = MSG_LEN + CRC_LEN; i > 0; i--) //32 = 4*8
	{
		if (((rem >> (i - 1)) & 0x01) != 0)
		{
			rem ^= divider;
		}
		divider >>= 1;
		if ((rem & mask) == 0) //end of calc
		{
			break;
		}
	}
	// Return 8-bit CRC calculated
	return (uint8_t)(rem & MAX_CRC);
}
static uint32_t form_acc(float acceleration,bool axis)
{
	uint8_t valH0,valL0,valL,valH,B0,B1,B2,B3;
	int16_t acc_val=round(20.47*acceleration);
	uint32_t formed_acceleration;
	uint8_t RCOMMAND;
	if(acc_val>=0)
	     {
          valL0 = (uint8_t) ((acc_val<<4) & 0x00ff);
          valH0 = (uint8_t) (((acc_val<<4) & 0xff00) >> 8);
          valL=valL0;
          valH=valH0;
	     }
	     else
	     {
          valL0 = (uint8_t) (((-acc_val)<<4) & 0x00ff);
          valH0 = (uint8_t) (((((-acc_val)<<4) & 0xff00) >> 8));
          valL=~valL0+1;
          valH=~valH0;
	     }
	if(axis==X) RCOMMAND=RCOMMAND0x00;
  else RCOMMAND=RCOMMAND0x02;		
	B0=(RCOMMAND|(valH>>6));
  B1=((valH<<2)|(valL>>6));
  B2=(valL<<2);
  B3=CRC8((((uint32_t)B0)<<24)|(((uint32_t)B1)<<16)|(((uint32_t)B2)<<8));
	formed_acceleration=(((uint32_t)B0)<<24)|(((uint32_t)B1)<<16)|(((uint32_t)B2)<<8)|((uint32_t)B3);
	return formed_acceleration;
}
static uint32_t buffer_average_value(uint32_t *buffer_to_evaluate, uint8_t size)
{
	uint8_t counter;
	uint64_t sum;
	uint32_t average;
  for(counter=0;counter<size;counter++)
	{
		sum+=buffer_to_evaluate[counter];
	}
	average=sum/counter;
	return average;	
}
static void FDCAN1_Config(void)
{
 // FDCAN_FilterTypeDef Filter1;

   /* Configure Rx filter*/ 
  /*Filter1.IdType = FDCAN_STANDARD_ID;
  Filter1.FilterIndex = 0;
  Filter1.FilterType = FDCAN_FILTER_MASK;
  Filter1.FilterConfig = FDCAN_FILTER_TO_RXFIFO0;
  Filter1.FilterID1 = 0x321;
  Filter1.FilterID2 = 0x7FF;
  if (HAL_FDCAN_ConfigFilter(&hfdcan1, &Filter1) != HAL_OK)
  {
    Error_Handler();
  }*/

  // Configure global filter:
  if (HAL_FDCAN_ConfigGlobalFilter(&hfdcan1, FDCAN_ACCEPT_IN_RX_FIFO0, FDCAN_ACCEPT_IN_RX_FIFO0, FDCAN_FILTER_REMOTE, FDCAN_FILTER_REMOTE) != HAL_OK)
  {
    Error_Handler();
  }

  // Start the FDCAN module 
  if (HAL_FDCAN_Start(&hfdcan1) != HAL_OK)
  {
    Error_Handler();
  }

  if (HAL_FDCAN_ActivateNotification(&hfdcan1, FDCAN_IT_RX_FIFO0_NEW_MESSAGE, 0) != HAL_OK)
  {
    Error_Handler();
  }

   //Prepare Tx Header 
  TxHeader.Identifier = 0x555;
  TxHeader.IdType = FDCAN_STANDARD_ID;
  TxHeader.TxFrameType = FDCAN_DATA_FRAME;
  TxHeader.DataLength = FDCAN_DLC_BYTES_8;
  TxHeader.ErrorStateIndicator = FDCAN_ESI_ACTIVE;
  TxHeader.BitRateSwitch = FDCAN_BRS_OFF;
  TxHeader.FDFormat = FDCAN_CLASSIC_CAN;
  TxHeader.TxEventFifoControl = FDCAN_NO_TX_EVENTS;
  TxHeader.MessageMarker = 0;
}

void vApplicationIdleHook( void )
{
  HAL_GPIO_WritePin(GPIOB,GPIO_PIN_0,GPIO_PIN_SET);//green
	HAL_UART_Receive(&huart4,UARTRXcmd,2,1000);
	
	switch(UARTRXcmd[0])
{
		case 0x01:
	{
		//UARTRXcmd[0]=0x00;
		HAL_GPIO_WritePin(GPIOB,GPIO_PIN_0,GPIO_PIN_RESET);
		vTaskResume(Init_testHandle);
		xTaskNotifyGive(Init_testHandle);
	}
	  case 0x02:
  {
		//UARTRXcmd[0]=0x00;
		HAL_GPIO_WritePin(GPIOB,GPIO_PIN_0,GPIO_PIN_RESET);
		vTaskResume(CAN_periodHandle);
		xTaskNotifyGive(CAN_periodHandle);
	}
		case 0x03:
  {
		//UARTRXcmd[0]=0x00;
		HAL_GPIO_WritePin(GPIOB,GPIO_PIN_0,GPIO_PIN_RESET);
		vTaskResume(Accelerometer_runHandle);
		xTaskNotifyGive(Accelerometer_runHandle);
	}
		case 0x04:
  {
		//UARTRXcmd[0]=0x00;
		HAL_GPIO_WritePin(GPIOB,GPIO_PIN_0,GPIO_PIN_RESET);
		vTaskResume(Accelerometer_runHandle);
		xTaskNotifyGive(Accelerometer_runHandle);
	}
		default: __NOP();
}	
}
/* USER CODE END 4 */

/* USER CODE BEGIN Header_Init_test_run */
/**
  * @brief  Function implementing the Init_test thread.
  * @param  argument: Not used
  * @retval None
  */
/* USER CODE END Header_Init_test_run */
void Init_test_run(void *argument)
{
  /* USER CODE BEGIN 5 */
	/*Certain implementation is given in HAL_FDCAN_RxFifo0Callback*/
  /* Infinite loop */
  for(;;)
  {
		ulTaskNotifyTake(0,portMAX_DELAY);
		time=0;
		//HAL_FDCAN_AddMessageToTxFifoQ(&hfdcan1,&TxHeader,testbuf);
    vTaskSuspend(Init_testHandle);		
  }
  /* USER CODE END 5 */
}

/* USER CODE BEGIN Header_CAN_2_RUN */
/**
* @brief Function implementing the CAN_2 thread.
* @param argument: Not used
* @retval None
*/
/* USER CODE END Header_CAN_2_RUN */
void CAN_2_RUN(void *argument)
{
  /* USER CODE BEGIN CAN_2_RUN */
	/*Certain implementation is given in HAL_FDCAN_RxFifo0Callback*/
  /* Infinite loop */
  for(;;)
  {
		ulTaskNotifyTake(0,portMAX_DELAY);
    //osDelay(100);
		vTaskSuspend(CAN_periodHandle);
  }
  /* USER CODE END CAN_2_RUN */
}

/* USER CODE BEGIN Header_Accelerometer1_RUN */
/**
* @brief Function implementing the Accelerometer_trig thread.
* @param argument: Not used
* @retval None
*/
/* USER CODE END Header_Accelerometer1_RUN */
void Accelerometer1_RUN(void *argument)
{
  /* USER CODE BEGIN Accelerometer1_RUN */
	/*Runs the accelerometer emualator, set of accelerations is depended on byte received via UART
	Frame forming is given in HAL_SPI_TxRxCpltCallback*/
  /* Infinite loop */
  for(;;)
  {
		ulTaskNotifyTake(0,portMAX_DELAY);
    while(timeX<0)
		{		
		HAL_SPI_TransmitReceive_IT(&hspi3,SPI_resp,SPI_RXbuf,4);//1000);	
    HAL_Delay(50);//Must be removed
		}
		HAL_GPIO_WritePin(POWER_GOOD_GPIO_Port,POWER_GOOD_Pin,GPIO_PIN_SET);
		time = 0;
		while(timeX<300&&SPI_STOP_FLAG==false)
		{
			HAL_SPI_TransmitReceive_IT(&hspi3,SPI_resp,SPI_RXbuf,4);//1000);	
      HAL_Delay(50);//Must be removed
		}
		vTaskSuspend(Accelerometer_runHandle);
  }
  /* USER CODE END Accelerometer1_RUN */
}

/**
  * @brief  Period elapsed callback in non blocking mode
  * @note   This function is called  when TIM13 interrupt took place, inside
  * HAL_TIM_IRQHandler(). It makes a direct call to HAL_IncTick() to increment
  * a global variable "uwTick" used as application time base.
  * @param  htim : TIM handle
  * @retval None
  */
void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)
{
  /* USER CODE BEGIN Callback 0 */
  if(htim->Instance == TIM1) //check if the interrupt comes from TIM1
		{
			time++; 
			//HAL_GPIO_TogglePin(GPIOC,GPIO_PIN_9); DEBUG
		}
  /* USER CODE END Callback 0 */
  if (htim->Instance == TIM13) {
    HAL_IncTick();
  }
  /* USER CODE BEGIN Callback 1 */

  /* USER CODE END Callback 1 */
}

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */
